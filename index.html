<!DOCTYPE html>
<html lang="fr">
<head>
 <style>
  @keyframes slide-in-right {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }
  .animate-slide-in-right {
    animation: slide-in-right 0.3s ease-out;
  }
</style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P-Shop</title>
  <!-- PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#ec4899">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="https://i.postimg.cc/ZRscyVKS/b4beb632-78c8-4f8d-8491-02da1b2545ee.png">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase SDK v9 Compat (plus simple √† utiliser) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAsgQfVmNvzNpu9L8LkefHR5IBI_QiwAV4",
      authDomain: "p-shop-6afae.firebaseapp.com",
      projectId: "p-shop-6afae",
      storageBucket: "p-shop-6afae.firebasestorage.app",
      messagingSenderId: "996187114750",
      appId: "1:996187114750:web:79d30a82bc47f502a169af"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Rendre disponible globalement
    window.firestoreDb = db;
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useMemo, useCallback, useEffect } = React;
    

    // ==================== PARTIE 1/6 : CONFIGURATION & HELPERS (CORRIG√âE) ===================
  
    const INITIAL_FLAVORS = [
      'Sakura Grape 16k', 'Blue Razz Ice 16k', 'Cherry Berry 16k',
      'Summer Peach Ice 16k', 'Berry Burst 16k', 'Watermelon Ice 16k',
      'Coca', 'Grape Ice 18k', 'Mango Ice', 'Strawberry Kiwi'
    ];

    // NOUVEAUX PALIERS : seulement Platine et Premium
    const LOYALTY_TIERS = [
      { name: 'Platine', minPoints: 0, color: 'from-purple-500 to-pink-400' },
      { name: 'Premium', minPoints: 1500, color: 'from-yellow-500 via-orange-500 to-red-500' }
    ];

    const S = {
      btn: "font-bold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2 disabled:opacity-50",
      primary: "bg-gradient-to-r from-pink-500 to-orange-500 text-white hover:scale-105",
      secondary: "bg-pink-500/20 hover:bg-pink-500/30 text-pink-400",
      input: "w-full bg-white/10 border border-pink-500/30 rounded-xl p-3 text-white placeholder-pink-300/50",
      card: "bg-black/40 backdrop-blur-xl rounded-2xl border-2 border-pink-500/50 overflow-hidden shadow-2xl"
    };

    // ==================== HELPERS FIREBASE ====================
    const saveToFirestore = async (collection, data) => {
      try {
        if (collection === 'pshop_products') {
          const batch = db.batch();
          const snapshot = await db.collection(collection).get();
          snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
          });
          data.forEach(product => {
            const docRef = db.collection(collection).doc(String(product.id));
            batch.set(docRef, product);
          });
          await batch.commit();
          console.log(`‚úÖ Sauvegarde ${collection} r√©ussie (${data.length} produits)`);
          return;
        }
        await db.collection(collection).doc('data').set({ value: data });
        console.log(`‚úÖ Sauvegarde ${collection} r√©ussie`);
      } catch (error) {
        console.error(`‚ùå Erreur sauvegarde ${collection}:`, error);
        alert(`Erreur de sauvegarde: ${error.message}`);
      }
    };

    const loadFromFirestore = async (collection, defaultValue) => {
      try {
        if (collection === 'pshop_products') {
          const snapshot = await db.collection(collection).get();
          if (!snapshot.empty) {
            const products = snapshot.docs.map(doc => doc.data());
            console.log(`‚úÖ Chargement ${collection} r√©ussi (${products.length} produits)`);
            return products;
          }
          console.log(`‚ö†Ô∏è ${collection} vide, utilisation valeur par d√©faut`);
          return defaultValue;
        }
        const doc = await db.collection(collection).doc('data').get();
        if (doc.exists) {
          console.log(`‚úÖ Chargement ${collection} r√©ussi`);
          return doc.data().value;
        }
        console.log(`‚ö†Ô∏è ${collection} n'existe pas, utilisation valeur par d√©faut`);
        return defaultValue;
      } catch (error) {
        console.error(`‚ùå Erreur chargement ${collection}:`, error);
        return defaultValue;
      }
    };

    // ==================== COMPOSANTS IC√îNES ====================
    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        ShoppingCart: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>,
        Search: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
        Plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        Minus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        Edit: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
        Trash2: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
        Package: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
        LogOut: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
        DollarSign: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
        TrendingUp: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
        BarChart3: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
        Upload: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
        X: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        Eye: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
        Phone: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
        List: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
        Heart: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
        Menu: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
        Home: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
        Gift: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>,
        Tag: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
        BookOpen: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        Users: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        Camera: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
        Check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
        Star: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
        ChevronRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>,
        ChevronLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"/></svg>
      };
      return icons[name] || null;
    };

    // ==================== COMPOSANTS UI DE BASE ====================
    const Button = ({ children, onClick, variant = 'primary', className = '', disabled }) => (
      <button onClick={onClick} disabled={disabled} className={`${S.btn} ${S[variant]} ${className}`}>
        {children}
      </button>
    );

    const Input = ({ icon, ...props }) => (
      <div className="relative">
        {icon && <Icon name={icon} size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-pink-400" />}
        <input {...props} className={`${S.input} ${icon ? 'pl-12' : ''}`} />
      </div>
    );

    const Card = ({ children, className = '', hover }) => (
      <div className={`${S.card} ${hover ? 'hover:scale-105 transition' : ''} ${className}`}>
        {children}
      </div>
    );


// ==================== FIN PARTIE 1/6 CORRIG√âE ====================
// COPIEZ LA PARTIE 2/6 JUSTE APR√àS CETTE LIGNE
// ==================== PARTIE 2/6 : MODALS & UTILITAIRES (CORRIG√âE) ====================

    // Fonction pour g√©n√©rer un code de parrainage unique
    const generateReferralCode = (name) => {
      return `PUFF${name.toUpperCase().substring(0, 3)}${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
    };

    // Fonction pour calculer le palier de fid√©lit√©
    const getLoyaltyTier = (points) => {
      for (let i = LOYALTY_TIERS.length - 1; i >= 0; i--) {
        if (points >= LOYALTY_TIERS[i].minPoints) {
          return LOYALTY_TIERS[i];
        }
      }
      return LOYALTY_TIERS[0];
    };

    // Fonction pour obtenir le badge de statut
    const getStatusBadge = (status) => {
      const badges = {
        pending: <span className="bg-orange-500/20 text-orange-400 px-3 py-1 rounded-full text-xs font-bold">‚è≥ En attente</span>,
        confirmed: <span className="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-xs font-bold">‚úÖ Confirm√©e</span>,
        delivered: <span className="bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full text-xs font-bold">üì¶ Livr√©e</span>
      };
      return badges[status] || badges.pending;
    };

    // ==================== MODAL TUTORIEL (NOUVEAU) ====================
    const TutorialModal = ({ onClose }) => {
      const [step, setStep] = useState(0);

      const tutorialSteps = [
        {
          icon: 'ShoppingCart',
          title: 'üõçÔ∏è Commander des produits',
          description: 'Parcourez notre catalogue, ajoutez vos produits pr√©f√©r√©s au panier et validez votre commande. Choisissez votre m√©thode de paiement (PayPal ou Cash).'
        },
        {
          icon: 'Star',
          title: '‚≠ê Gagner des points',
          description: 'Gagnez 10 points par euro d√©pens√©. Accumulez des points pour d√©bloquer le niveau Premium (1500 pts) et profiter d\'avantages exclusifs comme 2 puffs pour 15‚Ç¨ !'
        },
        {
          icon: 'Gift',
          title: 'üéÅ Parrainer des amis',
          description: 'Partagez votre code de parrainage unique avec vos amis. Vous gagnez 100 points et votre filleul re√ßoit 50 points de bienvenue !'
        },
        {
          icon: 'Heart',
          title: '‚ù§Ô∏è Cr√©er vos favoris',
          description: 'Cliquez sur le c≈ìur pour ajouter vos produits pr√©f√©r√©s √† vos favoris. Retrouvez-les facilement dans le menu "Mes Favoris".'
        },
        {
          icon: 'List',
          title: 'üìä Participer au sondage',
          description: 'Donnez votre avis en s√©lectionnant vos go√ªts pr√©f√©r√©s dans le sondage. Cela nous aide √† am√©liorer notre catalogue !'
        }
      ];

      const currentStep = tutorialSteps[step];
      const isLastStep = step === tutorialSteps.length - 1;

      return (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className={`${S.card} max-w-2xl w-full`}>
            <div className="p-8">
              <div className="text-center mb-8">
                <div className="inline-block bg-gradient-to-r from-pink-500 to-orange-500 p-6 rounded-3xl mb-6">
                  <Icon name={currentStep.icon} size={64} className="text-white" />
                </div>
                <h2 className="text-3xl font-black text-white mb-4">{currentStep.title}</h2>
                <p className="text-pink-300 text-lg leading-relaxed">{currentStep.description}</p>
              </div>

              {/* Indicateurs de progression */}
              <div className="flex justify-center gap-2 mb-8">
                {tutorialSteps.map((_, idx) => (
                  <div
                    key={idx}
                    className={`h-2 rounded-full transition-all ${
                      idx === step
                        ? 'w-8 bg-gradient-to-r from-pink-500 to-orange-500'
                        : 'w-2 bg-white/20'
                    }`}
                  />
                ))}
              </div>

              {/* Boutons de navigation */}
              <div className="flex gap-3">
                <Button
                  onClick={onClose}
                  variant="secondary"
                  className="flex-1"
                >
                  Passer
                </Button>
                
                {!isLastStep ? (
                  <Button
                    onClick={() => setStep(step + 1)}
                    className="flex-1"
                  >
                    Suivant
                    <Icon name="ChevronRight" size={20} />
                  </Button>
                ) : (
                  <Button
                    onClick={onClose}
                    className="flex-1"
                  >
                    <Icon name="Check" size={20} />
                    Commencer !
                  </Button>
                )}
              </div>

              {/* Compteur d'√©tapes */}
              <p className="text-center text-pink-300 text-sm mt-4">
                √âtape {step + 1} sur {tutorialSteps.length}
              </p>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MODAL D√âTAILS PRODUIT ====================
    const Modal = ({ product, onClose, onAddToCart, isFavorite, onToggleFavorite }) => {
      if (!product) return null;
      
      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className={`${S.card} max-w-2xl w-full`} onClick={e => e.stopPropagation()}>
            <div className="relative">
              <img src={product.img} alt={product.name} className="w-full h-96 object-cover" />
              <button onClick={onClose} className="absolute top-4 right-4 bg-black/60 hover:bg-black/80 text-white p-2 rounded-full transition">
                <Icon name="X" size={24} />
              </button>
              {onToggleFavorite && (
                <button 
                  onClick={() => onToggleFavorite(product.id)} 
                  className="absolute top-4 left-4 bg-black/60 hover:bg-black/80 text-white p-2 rounded-full transition"
                >
                  <Icon name="Heart" size={24} className={isFavorite ? 'fill-pink-500 text-pink-500' : ''} />
                </button>
              )}
            </div>
            <div className="p-6">
              <h2 className="text-3xl font-black text-white mb-4">{product.name}</h2>
              <p className="text-pink-300 text-lg mb-6">{product.desc}</p>
              <div className="flex justify-between items-center mb-4">
                <span className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                  {product.price.toFixed(2)}‚Ç¨
                </span>
                <span className="text-pink-300">Stock: {product.stock} unit√©{product.stock > 1 ? 's' : ''}</span>
              </div>
              {onAddToCart && (
                <Button onClick={() => { onAddToCart(product); onClose(); }} className="w-full" disabled={product.stock <= 0}>
                  <Icon name="ShoppingCart" size={20} />
                  AJOUTER AU PANIER
                </Button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ==================== MODAL SONDAGE GO√õTS ====================
    const SurveyModal = ({ onClose, flavors, onSubmit, userFlavors }) => {
      const [selected, setSelected] = useState(userFlavors || []);
      const [newFlavor, setNewFlavor] = useState('');

      const toggleFlavor = (flavor) => {
        if (selected.includes(flavor)) {
          setSelected(selected.filter(f => f !== flavor));
        } else if (selected.length < 5) {
          setSelected([...selected, flavor]);
        } else {
          alert('Maximum 5 go√ªts s√©lectionn√©s');
        }
      };

      const addNewFlavor = () => {
        if (!newFlavor.trim()) return;
        if (flavors.includes(newFlavor)) {
          alert('Ce go√ªt existe d√©j√†');
          return;
        }
        setSelected([...selected, newFlavor]);
        setNewFlavor('');
      };

      const handleSubmit = () => {
        if (selected.length < 2) {
          alert('Veuillez s√©lectionner au moins 2 go√ªts');
          return;
        }
        onSubmit(selected);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className={`${S.card} max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-black text-white flex items-center gap-2">
                  üç¶ Modifier Produits
                </h2>
                <button onClick={onClose} className="text-pink-400 hover:text-pink-300">
                  <Icon name="X" size={24} />
                </button>
              </div>
              
              <p className="text-pink-300 mb-6">
                S√©lectionnez entre 2 et 5 produits pr√©f√©r√©s ({selected.length}/5)
              </p>

              <div className="grid grid-cols-2 gap-3 mb-6">
                {flavors.map((flavor, idx) => (
                  <button
                    key={idx}
                    onClick={() => toggleFlavor(flavor)}
                    className={`p-3 rounded-xl border-2 transition ${
                      selected.includes(flavor)
                        ? 'bg-pink-500/30 border-pink-500 text-white'
                        : 'bg-white/5 border-pink-500/30 text-pink-300 hover:border-pink-500/50'
                    }`}
                  >
                    {flavor}
                  </button>
                ))}
              </div>

              <div className="mb-6">
                <p className="text-pink-300 mb-3">Ou proposez un nouveau produit :</p>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={newFlavor}
                    onChange={(e) => setNewFlavor(e.target.value)}
                    placeholder="Votre suggestion..."
                    className={S.input}
                  />
                  <button
                    onClick={addNewFlavor}
                    className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-3 rounded-xl"
                  >
                    <Icon name="Plus" size={24} />
                  </button>
                </div>
              </div>

              {selected.length > 0 && (
                <div className="mb-6">
                  <p className="text-pink-300 mb-3">S√©lectionn√©es :</p>
                  <div className="flex flex-wrap gap-2">
                    {selected.map((flavor, idx) => (
                      <span
                        key={idx}
                        className="bg-pink-500/20 text-pink-300 px-3 py-1 rounded-full text-sm flex items-center gap-2"
                      >
                        {flavor}
                        <button onClick={() => toggleFlavor(flavor)} className="hover:text-pink-100">
                          <Icon name="X" size={16} />
                        </button>
                      </span>
                    ))}
                  </div>
                </div>
              )}

              <Button onClick={handleSubmit} className="w-full" disabled={selected.length < 2}>
                MODIFIER ({selected.length}/5)
              </Button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MODAL SCANNER QR CODE ====================
    const QRScannerModal = ({ onClose, onValidate }) => {
      const [orderCode, setOrderCode] = useState('');
      const [scanning, setScanning] = useState(false);
      const videoRef = React.useRef(null);
      const [stream, setStream] = React.useState(null);

      const startCamera = async () => {
  try {
    const mediaStream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' } 
    });
    setStream(mediaStream);
    if (videoRef.current) {
      videoRef.current.srcObject = mediaStream;
      // AJOUT IMPORTANT : D√©marrer la lecture de la vid√©o
      await videoRef.current.play();
    }
    setScanning(true);
  } catch (error) {
    alert('Impossible d\'acc√©der √† la cam√©ra. Utilisez la saisie manuelle.');
    setScanning(false);
  }
};

      const stopCamera = () => {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          setStream(null);
        }
        setScanning(false);
      };

      React.useEffect(() => {
        return () => {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
        };
      }, [stream]);

      const handleValidate = () => {
        if (!orderCode.trim()) {
          alert('Veuillez entrer un code de commande');
          return;
        }
        stopCamera();
        onValidate(orderCode);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => { stopCamera(); onClose(); }}>
          <div className="bg-black/40 backdrop-blur-xl rounded-2xl border-2 border-pink-500/50 max-w-lg w-full" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-black text-white flex items-center gap-2">
                  üì∑ Scanner QR Code
                </h2>
                <button onClick={() => { stopCamera(); onClose(); }} className="text-pink-400 hover:text-pink-300">
                  <Icon name="X" size={24} />
                </button>
              </div>

              {!scanning ? (
                <Button onClick={startCamera} className="w-full mb-6">
                  <Icon name="Camera" size={20} />
                  ACTIVER LA CAM√âRA
                </Button>
              ) : (
                <div className="bg-white/5 rounded-xl p-4 mb-6 border-2 border-pink-500/30">
                  <video 
                    ref={videoRef}
                    autoPlay 
                    playsInline
                    className="w-full rounded-lg"
                  />
                  <Button onClick={stopCamera} variant="secondary" className="w-full mt-4">
                    Arr√™ter le scanner
                  </Button>
                </div>
              )}

              <p className="text-pink-300 text-center mb-4">ou entrez le code manuellement :</p>

              <div className="mb-6">
                <div className="relative">
                  <Icon name="Package" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-pink-400" />
                  <input
                    type="text"
                    value={orderCode}
                    onChange={(e) => setOrderCode(e.target.value)}
                    placeholder="PSHOP_ORDER_123456"
                    className="w-full bg-white/10 border border-pink-500/30 rounded-xl p-3 text-white placeholder-pink-300/50 pl-12"
                  />
                </div>
              </div>

              <Button onClick={handleValidate} className="w-full">
                VALIDER LIVRAISON
              </Button>
            </div>
          </div>
        </div>
      );
    };

    // ==================== MODAL MENU MOBILE (CORRIG√â - √Ä DROITE) ====================
    const MobileMenu = ({ user, onNavigate, onLogout, onClose }) => {
      const menuItems = user.role === 'client' ? [
        { icon: 'Home', label: 'Accueil', view: 'home' },
        { icon: 'Heart', label: 'Mes Favoris', view: 'favorites' },
        { icon: 'ShoppingCart', label: 'Mon Panier', view: 'cart' },
        { icon: 'List', label: 'Mes Commandes', view: 'orders' },
        { icon: 'Gift', label: 'Parrainage', view: 'referral' },
        { icon: 'Tag', label: 'Mes Codes Promo', view: 'promo' },
        { icon: 'BookOpen', label: 'Voir le tutoriel', view: 'tutorial' }
      ] : [
        { icon: 'Home', label: 'Accueil', view: 'home' },
        { icon: 'BarChart3', label: 'Statistiques', view: 'stats' },
        { icon: 'Package', label: 'Gestion Produits', view: 'admin' },
        { icon: 'Users', label: 'Gestion Comptes', view: 'accounts' },
        { icon: 'Camera', label: 'Scanner QR', view: 'scanner' }
      ];

      return (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex" onClick={onClose}>
          {/* Espace vide √† gauche pour fermer */}
          <div className="flex-1" onClick={onClose} />
          
          {/* Menu √† DROITE */}
          <div className="bg-gradient-to-br from-purple-900/95 via-pink-800/95 to-orange-700/95 w-80 h-full p-6 shadow-2xl animate-slide-in-right" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-8">
              <h2 className="text-2xl font-black text-white">Menu</h2>
              <button onClick={onClose} className="text-pink-400 hover:text-pink-300">
                <Icon name="X" size={28} />
              </button>
            </div>

            <div className="space-y-2">
              {menuItems.map((item, idx) => (
                <button
                  key={idx}
                  onClick={() => { onNavigate(item.view); onClose(); }}
                  className="w-full flex items-center gap-4 p-4 rounded-xl bg-white/5 hover:bg-white/10 text-pink-100 transition"
                >
                  <Icon name={item.icon} size={24} />
                  <span className="text-lg">{item.label}</span>
                </button>
              ))}

              <button
                onClick={() => { onLogout(); onClose(); }}
                className="w-full flex items-center gap-4 p-4 rounded-xl bg-red-500/20 hover:bg-red-500/30 text-red-400 transition mt-6"
              >
                <Icon name="LogOut" size={24} />
                <span className="text-lg">D√©connexion</span>
              </button>
            </div>

            {user && (
              <div className="absolute bottom-6 left-6 right-6">
                <div className="bg-black/40 rounded-xl p-4 border-2 border-pink-500/30">
                  <p className="text-pink-300 text-sm mb-1">üëã Connect√© en tant que</p>
                  <p className="text-white font-bold text-lg">{user.name}</p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

// ==================== FIN PARTIE 2/6 CORRIG√âE ====================
// COPIEZ LA PARTIE 3/6 JUSTE APR√àS CETTE LIGNE
// ==================== PARTIE 3/6 : VUE LOGIN & NAVIGATION (CORRIG√âE) ====================

    // ==================== VUE LOGIN/INSCRIPTION ====================
    const LoginView = ({ onLogin, onRegister }) => {
      const [mode, setMode] = useState('login');
      const [rememberMe, setRememberMe] = useState(false);
      const [form, setForm] = useState({ 
        name: '', 
        password: '', 
        confirmPassword: '', 
        phone: '',
        referralCode: '' 
      });
      
      const handleSubmit = () => {
        if (!form.name || !form.password) {
          return alert('Veuillez remplir tous les champs');
        }
        
        if (mode === 'register') {
          if (!form.phone) return alert('Veuillez entrer votre num√©ro de t√©l√©phone');
          if (!form.confirmPassword) return alert('Veuillez confirmer le mot de passe');
          if (form.password !== form.confirmPassword) return alert('Les mots de passe ne correspondent pas');
          if (form.password.length < 6) return alert('Le mot de passe doit contenir au moins 6 caract√®res');
          onRegister(form, rememberMe);
        } else {
          onLogin(form, rememberMe);
        }
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 via-pink-800 to-orange-700 flex items-center justify-center p-4">
          <Card className="p-8 max-w-md w-full">
            <div className="text-center mb-8">
              {/* LOGO P-SHOP */}
              <div className="w-32 h-32 mx-auto mb-4">
                <img 
                  src="https://i.postimg.cc/ZRscyVKS/b4beb632-78c8-4f8d-8491-02da1b2545ee.png" 
                  alt="P-Shop Logo" 
                  className="w-full h-full object-contain drop-shadow-2xl"
                />
              </div>
              
              {/* NOM DU SITE */}
              <h1 className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400 mb-2">
                P-SHOP
              </h1>
              <p className="text-pink-300 text-sm">Votre boutique de coques premium</p>
            </div>
            
            <div className="flex gap-2 mb-6">
              <Button 
                onClick={() => setMode('login')} 
                variant={mode === 'login' ? 'primary' : 'secondary'} 
                className="flex-1"
              >
                Connexion
              </Button>
              <Button 
                onClick={() => setMode('register')} 
                variant={mode === 'register' ? 'primary' : 'secondary'} 
                className="flex-1"
              >
                Inscription
              </Button>
            </div>
            
            <div className="space-y-3">
              <Input 
                type="text" 
                placeholder="Identifiant" 
                value={form.name} 
                onChange={e => setForm({...form, name: e.target.value})} 
              />
              
              {mode === 'register' && (
                <Input 
                  type="tel" 
                  placeholder="Num√©ro de t√©l√©phone" 
                  value={form.phone} 
                  onChange={e => setForm({...form, phone: e.target.value})} 
                  icon="Phone" 
                />
              )}
              
              <Input 
                type="password" 
                placeholder="Mot de passe" 
                value={form.password} 
                onChange={e => setForm({...form, password: e.target.value})} 
              />
              
              {mode === 'register' && (
                <>
                  <Input 
                    type="password" 
                    placeholder="Confirmer le mot de passe" 
                    value={form.confirmPassword} 
                    onChange={e => setForm({...form, confirmPassword: e.target.value})} 
                  />
                  <Input 
                    type="text" 
                    placeholder="Code de parrainage (optionnel)" 
                    value={form.referralCode} 
                    onChange={e => setForm({...form, referralCode: e.target.value})} 
                    icon="Gift"
                  />
                </>
              )}
              
              <Button onClick={handleSubmit} className="w-full">
                {mode === 'login' ? 'SE CONNECTER' : 'CR√âER COMPTE'}
              </Button>
              
              {/* OPTION RESTER CONNECT√â */}
              <div className="flex items-center gap-2 mt-4">
                <input
                  type="checkbox"
                  id="rememberMe"
                  checked={rememberMe}
                  onChange={(e) => setRememberMe(e.target.checked)}
                  className="w-4 h-4 accent-pink-500 cursor-pointer"
                />
                <label htmlFor="rememberMe" className="text-pink-300 text-sm cursor-pointer">
                  Rester connect√© sur cet appareil
                </label>
              </div>
            </div>
            
            <p className="text-pink-300/70 text-xs text-center mt-6">
              Vendeur: B-K
            </p>
          </Card>
        </div>
      );
    };

    // ==================== BARRE DE NAVIGATION ====================
    const Navigation = ({ user, cartCount, onNavigate, onLogout, points }) => {
      const [showMenu, setShowMenu] = useState(false);
      const tier = getLoyaltyTier(points);

      return (
        <>
          <nav className="bg-black/40 backdrop-blur-xl border-b-2 border-pink-500/50 sticky top-0 z-40">
            <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
              {/* LOGO + NOM DANS LA NAVIGATION */}
              <div 
                className="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" 
                onClick={() => onNavigate('home')}
              >
                <div className="w-12 h-12">
                  <img 
                    src="https://i.postimg.cc/ZRscyVKS/b4beb632-78c8-4f8d-8491-02da1b2545ee.png" 
                    alt="P-Shop" 
                    className="w-full h-full object-contain drop-shadow-lg"
                  />
                </div>
                <h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                  P-SHOP
                </h1>
              </div>
              
              <div className="flex items-center gap-3">
                {/* Desktop Navigation */}
                <div className="hidden md:flex items-center gap-3">
                  <span className="text-pink-300 text-sm">üëã {user.name}</span>
                  
                  {user.role === 'client' && (
                    <>
                      <div className="bg-pink-500/20 px-3 py-1 rounded-lg">
                        <span className="text-pink-300 text-sm">‚≠ê {points} pts</span>
                      </div>
                      <button 
                        onClick={() => onNavigate('favorites')} 
                        className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                      >
                        <Icon name="Heart" size={18} />
                      </button>
                      <button 
                        onClick={() => onNavigate('orders')} 
                        className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                      >
                        <Icon name="List" size={18} />
                      </button>
                      <button 
                        onClick={() => onNavigate('cart')} 
                        className="relative bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                      >
                        <Icon name="ShoppingCart" size={18} />
                        {cartCount > 0 && (
                          <span className="absolute -top-1 -right-1 bg-orange-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                            {cartCount}
                          </span>
                        )}
                      </button>
                    </>
                  )}
                  
                  {user.role === 'producer' && (
                    <>
                      <button 
                        onClick={() => onNavigate('stats')} 
                        className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                      >
                        <Icon name="BarChart3" size={18} />
                      </button>
                      <button 
                        onClick={() => onNavigate('admin')} 
                        className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                      >
                        <Icon name="Package" size={18} />
                      </button>
                      <button 
                        onClick={() => onNavigate('accounts')} 
                        className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                      >
                        <Icon name="Users" size={18} />
                      </button>
                    </>
                  )}
                  
                  <button 
                    onClick={onLogout} 
                    className="bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                  >
                    <Icon name="LogOut" size={18} />
                  </button>
                </div>

                {/* Mobile Menu Button */}
                <button 
                  onClick={() => setShowMenu(true)} 
                  className="md:hidden bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                >
                  <Icon name="Menu" size={24} />
                </button>
                
                {/* Cart badge for mobile */}
                {user.role === 'client' && cartCount > 0 && (
                  <button 
                    onClick={() => onNavigate('cart')} 
                    className="md:hidden relative bg-pink-500/20 hover:bg-pink-500/30 text-pink-400 p-2 rounded-lg transition"
                  >
                    <Icon name="ShoppingCart" size={20} />
                    <span className="absolute -top-1 -right-1 bg-orange-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                      {cartCount}
                    </span>
                  </button>
                )}
              </div>
            </div>
          </nav>

          {showMenu && (
            <MobileMenu 
              user={user} 
              onNavigate={onNavigate} 
              onLogout={onLogout} 
              onClose={() => setShowMenu(false)} 
            />
          )}
        </>
      );
    };

    // ==================== AFFICHAGE PALIER FID√âLIT√â (CORRIG√â) ====================
    const LoyaltyDisplay = ({ points }) => {
      const currentTier = getLoyaltyTier(points);
      const nextTier = LOYALTY_TIERS.find(t => t.minPoints > points);
      const progress = nextTier 
        ? ((points - currentTier.minPoints) / (nextTier.minPoints - currentTier.minPoints)) * 100 
        : 100;

      // Affichage sp√©cial pour le statut Premium
      const isPremium = currentTier.name === 'Premium';

      return (
        <Card className="p-6 mb-6">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className={`bg-gradient-to-r ${currentTier.color} w-12 h-12 rounded-full flex items-center justify-center`}>
                <Icon name="Star" size={24} className="text-white" />
              </div>
              <div>
                <p className="text-white font-bold text-xl">{currentTier.name}</p>
                <p className="text-pink-300 text-sm">{points} points</p>
              </div>
            </div>
            {nextTier && (
              <div className="text-right">
                <p className="text-pink-300 text-xs">Prochain palier</p>
                <p className="text-white font-bold">{nextTier.name}</p>
                <p className="text-pink-400 text-xs">{nextTier.minPoints - points} pts restants</p>
              </div>
            )}
          </div>
          
          {nextTier && (
            <div className="w-full bg-white/10 rounded-full h-2 overflow-hidden">
              <div 
                className={`h-full bg-gradient-to-r ${currentTier.color} transition-all duration-500`}
                style={{ width: `${progress}%` }}
              />
            </div>
          )}
          
          {isPremium && (
            <div className="bg-gradient-to-r from-yellow-500/20 via-orange-500/20 to-red-500/20 rounded-xl p-4 border border-yellow-500/30 mt-4">
              <p className="text-yellow-300 text-center font-bold mb-2">
                üéâ Vous √™tes Premium ! üéâ
              </p>
              <p className="text-yellow-200 text-center text-sm">
                Profitez de l'offre exclusive : 2 Puffs au choix pour seulement 15‚Ç¨ !
              </p>
            </div>
          )}
          
          {!nextTier && !isPremium && (
            <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-pink-500/30 mt-4">
              <p className="text-pink-300 text-center">
                üéâ Vous avez atteint le niveau maximum !
              </p>
            </div>
          )}
        </Card>
      );
    };

// ==================== FIN PARTIE 3/6 CORRIG√âE ====================
// COPIEZ LA PARTIE 4/6 JUSTE APR√àS CETTE LIGNE
// ==================== PARTIE 4/6 : VUES CLIENT ====================

   // ==================== PARTIE 4/6 : VUES CLIENT (CORRIG√âE) ====================

    // ==================== VUE ACCUEIL (PRODUITS) ====================
    const HomeView = ({ 
      products, 
      search, 
      setSearch, 
      onAddToCart, 
      onProductClick,
      favorites,
      onToggleFavorite,
      onOpenSurvey,
      userRole,
      userFlavors,
      userPoints
    }) => {
      const filteredProducts = useMemo(() => 
        products.filter(p => {
          if (!p || !p.name) return false;
          return p.name.toLowerCase().includes(search.toLowerCase());
        }), 
        [products, search]
      );

      // V√©rifier si l'utilisateur est Premium
      const isPremium = userPoints >= 1500;

      return (
        <>
          <div className="mb-6 space-y-4">
            <Input 
              type="text" 
              placeholder="Rechercher un produit..." 
              value={search} 
              onChange={e => setSearch(e.target.value)} 
              icon="Search" 
            />
            
            {/* OFFRE PREMIUM */}
            {userRole === 'client' && isPremium && (
              <div className="bg-gradient-to-r from-yellow-500/30 via-orange-500/30 to-red-500/30 border-2 border-yellow-500/50 rounded-xl p-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4">
                    <div className="bg-gradient-to-r from-yellow-500 to-red-500 p-4 rounded-full">
                      <Icon name="Star" size={32} className="text-white" />
                    </div>
                    <div>
                      <p className="text-white font-black text-xl mb-1">üéÅ Offre Premium Exclusive</p>
                      <p className="text-yellow-200 text-sm">2 Puffs au choix pour seulement 15‚Ç¨ !</p>
                      <p className="text-yellow-300 text-xs mt-1">Contactez le vendeur pour en profiter</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-400">
                      15‚Ç¨
                    </p>
                    <p className="text-yellow-300 text-xs">Au lieu de 20‚Ç¨</p>
                  </div>
                </div>
              </div>
            )}
            
            {userRole === 'client' && (
              <button
                onClick={onOpenSurvey}
                className="w-full bg-gradient-to-r from-pink-500/20 to-orange-500/20 hover:from-pink-500/30 hover:to-orange-500/30 border-2 border-pink-500/50 rounded-xl p-4 transition"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Icon name="List" size={24} className="text-pink-400" />
                    <div className="text-left">
                      <p className="text-white font-bold">Sondage Produits</p>
                      <p className="text-pink-300 text-sm">
                        {userFlavors?.length > 0 
                          ? `${userFlavors.length} go√ªts s√©lectionn√©s` 
                          : 'Choisissez vos go√ªts pr√©f√©r√©s'}
                      </p>
                    </div>
                  </div>
                  <Icon name="Edit" size={20} className="text-pink-400" />
                </div>
              </button>
            )}
          </div>

          {filteredProducts.length === 0 ? (
            <Card className="p-12 text-center">
              <Icon name="Search" size={64} className="mx-auto text-pink-400/30 mb-4" />
              <p className="text-pink-300 text-lg mb-4">Aucun produit trouv√©</p>
              {search && (
                <Button onClick={() => setSearch('')}>R√©initialiser la recherche</Button>
              )}
            </Card>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredProducts.map(p => {
                const isFavorite = favorites?.includes(p.id);
                return (
                  <Card key={p.id} hover>
                    <div className="relative group">
                      <img src={p.img} alt={p.name} className="w-full h-64 object-cover" />
                      
                      {p.stock <= 0 && (
                        <div className="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                          RUPTURE DE STOCK
                        </div>
                      )}
                      
                      {p.stock > 0 && p.stock <= 5 && (
                        <div className="absolute top-4 left-4 bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                          Stock limit√©: {p.stock}
                        </div>
                      )}
                      
                      {userRole === 'client' && (
                        <button
                          onClick={() => onToggleFavorite(p.id)}
                          className="absolute top-4 right-4 bg-black/60 hover:bg-black/80 p-2 rounded-full transition"
                        >
                          <Icon 
                            name="Heart" 
                            size={20} 
                            className={isFavorite ? 'fill-pink-500 text-pink-500' : 'text-white'} 
                          />
                        </button>
                      )}
                      
                      <button 
                        onClick={() => onProductClick(p)} 
                        className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center"
                      >
                        <div className="bg-white/20 backdrop-blur-sm p-3 rounded-full">
                          <Icon name="Eye" size={24} className="text-white" />
                        </div>
                      </button>
                    </div>
                    
                    <div className="p-4">
                      <h3 className="text-xl font-bold text-white mb-2">{p.name}</h3>
                      <p className="text-pink-300 text-sm mb-3 line-clamp-2">{p.desc}</p>
                      
                      <div className="flex justify-between items-center">
                        <div>
                          <span className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                            {p.price.toFixed(2)}‚Ç¨
                          </span>
                          <p className="text-pink-300 text-xs mt-1">Stock: {p.stock}</p>
                        </div>
                        
                        {userRole === 'client' && (
                          <Button 
                            onClick={() => onAddToCart(p)} 
                            className="text-sm px-3 py-2" 
                            disabled={p.stock <= 0}
                          >
                            AJOUTER
                          </Button>
                        )}
                      </div>
                    </div>
                  </Card>
                );
              })}
            </div>
          )}
        </>
      );
    };

    // ==================== VUE FAVORIS ====================
    const FavoritesView = ({ products, favorites, onProductClick, onAddToCart, onToggleFavorite }) => {
      const favoriteProducts = products.filter(p => favorites.includes(p.id));

      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">‚ù§Ô∏è Mes Favoris</h2>
          
          {favoriteProducts.length === 0 ? (
            <div className="text-center py-12">
              <Icon name="Heart" size={64} className="mx-auto text-pink-400/30 mb-4" />
              <p className="text-pink-300 text-lg mb-4">Aucun favori pour le moment</p>
              <p className="text-pink-400 text-sm">
                Cliquez sur le ‚ù§Ô∏è pour ajouter des produits √† vos favoris
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {favoriteProducts.map(p => (
                <Card key={p.id} hover>
                  <div className="relative group">
                    <img src={p.img} alt={p.name} className="w-full h-64 object-cover" />
                    
                    <button
                      onClick={() => onToggleFavorite(p.id)}
                      className="absolute top-4 right-4 bg-black/60 hover:bg-black/80 p-2 rounded-full transition"
                    >
                      <Icon name="Heart" size={20} className="fill-pink-500 text-pink-500" />
                    </button>
                    
                    <button 
                      onClick={() => onProductClick(p)} 
                      className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center"
                    >
                      <div className="bg-white/20 backdrop-blur-sm p-3 rounded-full">
                        <Icon name="Eye" size={24} className="text-white" />
                      </div>
                    </button>
                  </div>
                  
                  <div className="p-4">
                    <h3 className="text-xl font-bold text-white mb-2">{p.name}</h3>
                    <p className="text-pink-300 text-sm mb-3 line-clamp-2">{p.desc}</p>
                    
                    <div className="flex justify-between items-center">
                      <span className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                        {p.price.toFixed(2)}‚Ç¨
                      </span>
                      <Button 
                        onClick={() => onAddToCart(p)} 
                        className="text-sm px-3 py-2" 
                        disabled={p.stock <= 0}
                      >
                        AJOUTER
                      </Button>
                    </div>
                  </div>
                </Card>
              ))}
            </div>
          )}
        </Card>
      );
    };

    // ==================== VUE PANIER ====================
    const CartView = ({ cart, onUpdateQty, onRemoveItem, onCheckout, checkoutForm, setCheckoutForm }) => {
      const cartTotal = useMemo(() => cart.reduce((s, i) => s + i.price * i.qty, 0), [cart]);
      const cartItemCount = useMemo(() => cart.reduce((s, i) => s + i.qty, 0), [cart]);
      const pointsToEarn = Math.floor(cartTotal * 10);

      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üõí Mon Panier</h2>
          
          {cart.length === 0 ? (
            <div className="text-center py-12">
              <Icon name="ShoppingCart" size={64} className="mx-auto text-pink-400/30 mb-4" />
              <p className="text-pink-300 text-lg mb-4">Votre panier est vide</p>
            </div>
          ) : (
            <>
              {cart.map(i => (
                <div key={i.id} className="flex justify-between items-center bg-white/5 p-4 rounded-xl mb-3 border border-pink-500/20">
                  <div className="flex items-center gap-3">
                    <img src={i.img} alt={i.name} className="w-16 h-16 rounded-lg object-cover" />
                    <div>
                      <p className="text-white font-bold">{i.name}</p>
                      <div className="flex items-center gap-2 mt-1">
                        <button 
                          onClick={() => onUpdateQty(i.id, -1)} 
                          disabled={i.qty <= 1} 
                          className="bg-pink-500/20 p-1 rounded hover:bg-pink-500/30 disabled:opacity-50"
                        >
                          <Icon name="Minus" size={16} className="text-pink-400" />
                        </button>
                        <span className="text-pink-300 w-8 text-center">{i.qty}</span>
                        <button 
                          onClick={() => onUpdateQty(i.id, 1)} 
                          className="bg-pink-500/20 p-1 rounded hover:bg-pink-500/30"
                        >
                          <Icon name="Plus" size={16} className="text-pink-400" />
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-3">
                    <span className="text-white font-bold">{(i.price * i.qty).toFixed(2)}‚Ç¨</span>
                    <button 
                      onClick={() => onRemoveItem(i.id)} 
                      className="text-red-400 hover:text-red-300 p-2 hover:bg-red-400/10 rounded-lg"
                    >
                      <Icon name="Trash2" size={20} />
                    </button>
                  </div>
                </div>
              ))}
              
              <div className="border-t-2 border-pink-500/50 mt-6 pt-6">
                <div className="bg-gradient-to-r from-pink-500/10 to-orange-500/10 rounded-xl p-4 mb-4 border border-pink-500/30">
                  <div className="flex justify-between items-center">
                    <span className="text-pink-300">Vous allez gagner:</span>
                    <span className="text-white font-bold text-lg">‚≠ê +{pointsToEarn} points</span>
                  </div>
                </div>
                
                <div className="text-right mb-6">
                  <p className="text-pink-300 text-sm mb-1">{cartItemCount} article{cartItemCount > 1 ? 's' : ''}</p>
                  <span className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                    Total: {cartTotal.toFixed(2)}‚Ç¨
                  </span>
                </div>
                
                <div className="space-y-3">
                  <Input 
                    type="text" 
                    placeholder="Adresse de livraison √† Paris" 
                    value={checkoutForm.address} 
                    onChange={e => setCheckoutForm({...checkoutForm, address: e.target.value})} 
                  />
                  
                  <select 
                    className={S.input} 
                    value={checkoutForm.payment} 
                    onChange={e => setCheckoutForm({...checkoutForm, payment: e.target.value})}
                  >
                    <option value="">M√©thode de paiement</option>
                    <option value="paypal">PayPal</option>
                    <option value="cash">Cash</option>
                  </select>
                  
                  <Input 
                    type="text" 
                    placeholder="Code promo (optionnel)" 
                    value={checkoutForm.promoCode || ''} 
                    onChange={e => setCheckoutForm({...checkoutForm, promoCode: e.target.value})} 
                    icon="Tag"
                  />
                  
                  <Button 
                    onClick={onCheckout} 
                    className="w-full" 
                    disabled={!checkoutForm.address || !checkoutForm.payment}
                  >
                    <Icon name="ShoppingCart" size={20} />
                    COMMANDER ({cartTotal.toFixed(2)}‚Ç¨)
                  </Button>
                </div>
              </div>
            </>
          )}
        </Card>
      );
    };

    // ==================== VUE COMMANDES ====================
    const OrdersView = ({ orders }) => {
      const [showQR, setShowQR] = useState(null);

      return (
        <>
          <Card className="p-6">
            <h2 className="text-3xl font-black text-white mb-6">üì¶ Mes Commandes</h2>
            
            {orders.length === 0 ? (
              <div className="text-center py-12">
                <Icon name="Package" size={64} className="mx-auto text-pink-400/30 mb-4" />
                <p className="text-pink-300 text-lg mb-4">Aucune commande pour le moment</p>
              </div>
            ) : (
              <div className="space-y-4">
                {orders.sort((a, b) => b.id - a.id).map(o => (
                  <div key={o.id} className="bg-white/5 p-5 rounded-xl border border-pink-500/30">
                    <div className="flex justify-between items-start mb-4">
                      <div>
                        <p className="text-white font-bold text-lg mb-2">Commande #{o.id}</p>
                        <p className="text-pink-300 text-sm">üïê {o.date}</p>
                        <p className="text-pink-300 text-sm">üìç {o.address}</p>
                        <p className="text-pink-300 text-sm">üí≥ {o.payment}</p>
                      </div>
                      
                      <div className="text-right">
                        {getStatusBadge(o.status)}
                        <p className="text-white font-black text-2xl mt-2">{o.total.toFixed(2)}‚Ç¨</p>
                        {o.pointsEarned && (
                          <p className="text-pink-300 text-sm mt-1">‚≠ê +{o.pointsEarned} points gagn√©s</p>
                        )}
                      </div>
                    </div>
                    
                    {o.status === 'confirmed' && o.deliveryDate && (
                      <div className="bg-green-500/10 border border-green-500/30 p-4 rounded-lg mb-4">
                        <p className="text-green-400 font-bold mb-2">üìÖ Livraison pr√©vue:</p>
                        <p className="text-green-300">üóìÔ∏è Date: {o.deliveryDate}</p>
                        <p className="text-green-300">üïê Heure: {o.deliveryTime}</p>
                      </div>
                    )}
                    
                    <div className="pt-3 border-t border-pink-500/30 mb-4">
                      <p className="text-pink-300 text-sm mb-2 font-semibold">Articles:</p>
                      {o.items.map(i => (
                        <p key={i.id} className="text-pink-300 text-sm">
                          ‚Ä¢ {i.name} x{i.qty} - {(i.price * i.qty).toFixed(2)}‚Ç¨
                        </p>
                      ))}
                    </div>

                    {/* BOUTON QR CODE */}
                    {(o.status === 'confirmed' || o.status === 'pending') && (
                      <Button 
                        onClick={() => setShowQR(o)} 
                        variant="secondary" 
                        className="w-full"
                      >
                        <Icon name="Camera" size={20} />
                        VOIR LE QR CODE
                      </Button>
                    )}
                  </div>
                ))}
              </div>
            )}
          </Card>

          {/* MODAL QR CODE */}
          {showQR && (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setShowQR(null)}>
              <div className="bg-black/40 backdrop-blur-xl rounded-2xl border-2 border-pink-500/50 max-w-md w-full p-6" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-6">
                  <h3 className="text-2xl font-black text-white">üì¶ QR Code Livraison</h3>
                  <button onClick={() => setShowQR(null)} className="text-pink-400 hover:text-pink-300">
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <div className="bg-white p-6 rounded-xl mb-6">
                  <img 
                    src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=PSHOP_ORDER_${showQR.id}`}
                    alt="QR Code"
                    className="w-full h-auto"
                  />
                </div>

                <div className="bg-pink-500/10 border border-pink-500/30 rounded-xl p-4 mb-4">
                  <p className="text-pink-300 text-sm text-center mb-2">Code de commande :</p>
                  <p className="text-white text-xl font-black text-center">
                    PSHOP_ORDER_{showQR.id}
                  </p>
                </div>

                <p className="text-pink-300 text-sm text-center">
                  Pr√©sentez ce QR code au livreur pour valider la r√©ception
                </p>
              </div>
            </div>
          )}
        </>
      );
    };

// ==================== FIN PARTIE 4/6 CORRIG√âE ====================
// COPIEZ LA PARTIE 5/6 JUSTE APR√àS CETTE LIG
// ==================== PARTIE 5/6 : VUES PARRAINAGE, PROMO, TUTORIEL & ADMIN (CORRIG√âE) ====================

    // ==================== VUE PARRAINAGE ====================
    const ReferralView = ({ user, referrals }) => {
      const [copied, setCopied] = useState(false);
      
      const copyCode = () => {
        navigator.clipboard.writeText(user.referralCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üéÅ Programme Parrainage</h2>
          
          <p className="text-pink-300 mb-6">
            Invitez vos amis et gagnez des points !
          </p>
          
          <div className="bg-gradient-to-r from-pink-500/20 to-orange-500/20 rounded-2xl p-6 mb-6 border-2 border-pink-500/50">
            <div className="text-center mb-4">
              <div className="inline-block bg-gradient-to-r from-pink-500 to-orange-500 p-4 rounded-2xl mb-4">
                <Icon name="Gift" size={48} className="text-white" />
              </div>
              <h3 className="text-white font-bold text-xl mb-2">Votre Code Parrainage</h3>
              <div className="flex items-center justify-center gap-3">
                <span className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                  {user.referralCode}
                </span>
                <button
                  onClick={copyCode}
                  className="bg-pink-500/20 hover:bg-pink-500/30 p-3 rounded-xl transition"
                >
                  <Icon name={copied ? "Check" : "Gift"} size={24} className="text-pink-400" />
                </button>
              </div>
              {copied && <p className="text-green-400 text-sm mt-2">‚úÖ Code copi√© !</p>}
            </div>
            
            <p className="text-pink-300 text-center text-sm">
              Partagez ce code avec vos amis lors de leur inscription
            </p>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div className="bg-white/5 p-6 rounded-xl border border-green-500/30">
              <div className="flex items-center gap-3 mb-2">
                <Icon name="Users" size={32} className="text-green-400" />
                <div>
                  <p className="text-green-400 text-sm">Vous recevez</p>
                  <p className="text-white text-2xl font-black">+100 points</p>
                </div>
              </div>
            </div>
            
            <div className="bg-white/5 p-6 rounded-xl border border-blue-500/30">
              <div className="flex items-center gap-3 mb-2">
                <Icon name="Gift" size={32} className="text-blue-400" />
                <div>
                  <p className="text-blue-400 text-sm">Votre filleul re√ßoit</p>
                  <p className="text-white text-2xl font-black">+50 points</p>
                </div>
              </div>
            </div>
          </div>
          
          <div className="bg-white/5 rounded-xl p-6 border border-pink-500/30">
            <h3 className="text-white font-bold text-lg mb-4 flex items-center gap-2">
              <Icon name="Users" size={24} className="text-pink-400" />
              Vos Filleuls ({referrals?.length || 0})
            </h3>
            
            {(!referrals || referrals.length === 0) ? (
              <p className="text-pink-300 text-center py-8">
                Vous n'avez pas encore de filleuls
              </p>
            ) : (
              <div className="space-y-2">
                {referrals.map((ref, idx) => (
                  <div key={idx} className="flex justify-between items-center bg-white/5 p-3 rounded-lg">
                    <span className="text-white">üë§ {ref.name}</span>
                    <span className="text-green-400 text-sm">+100 pts</span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </Card>
      );
    };

    // ==================== VUE CODES PROMO ====================
    const PromoView = ({ promoCodes, onApplyPromo }) => {
      const [promoInput, setPromoInput] = useState('');

      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üéüÔ∏è Mes Codes Promo</h2>
          
          <div className="mb-6">
            <div className="flex gap-2">
              <Input
                type="text"
                placeholder="Entrez un code promo"
                value={promoInput}
                onChange={e => setPromoInput(e.target.value.toUpperCase())}
                icon="Tag"
              />
              <Button onClick={() => onApplyPromo?.(promoInput)}>
                V√©rifier
              </Button>
            </div>
          </div>
          
          {(!promoCodes || promoCodes.length === 0) ? (
            <div className="text-center py-12">
              <Icon name="Tag" size={64} className="mx-auto text-pink-400/30 mb-4" />
              <p className="text-pink-300 text-lg">Aucun code promo disponible</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {promoCodes.map((promo, idx) => (
                <div key={idx} className="bg-gradient-to-r from-pink-500/20 to-orange-500/20 rounded-xl p-6 border-2 border-pink-500/50">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <p className="text-pink-300 text-sm mb-1">Code</p>
                      <p className="text-white text-2xl font-black">{promo.code}</p>
                    </div>
                    <div className="bg-gradient-to-r from-pink-500 to-orange-500 text-white px-4 py-2 rounded-full text-sm font-bold">
                      -{promo.discount}{promo.type === 'percentage' ? '%' : '‚Ç¨'}
                    </div>
                  </div>
                  <p className="text-pink-300 text-sm mb-2">{promo.description}</p>
                  {promo.minAmount && (
                    <p className="text-pink-400 text-xs">
                      Minimum d'achat: {promo.minAmount}‚Ç¨
                    </p>
                  )}
                </div>
              ))}
            </div>
          )}
        </Card>
      );
    };

    // ==================== VUE TUTORIEL (PAGE STATIQUE) ====================
    const TutorialView = () => {
      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üìñ Tutoriel</h2>
          
          <div className="space-y-6">
            <div className="bg-white/5 rounded-xl p-6 border border-pink-500/30">
              <div className="flex items-start gap-4">
                <div className="bg-gradient-to-r from-pink-500 to-orange-500 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white font-black text-xl">1</span>
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg mb-2">üõçÔ∏è Commander des produits</h3>
                  <p className="text-pink-300 text-sm">
                    Parcourez notre catalogue, ajoutez vos produits pr√©f√©r√©s au panier et validez votre commande. 
                    Choisissez votre m√©thode de paiement (PayPal ou Cash).
                  </p>
                </div>
              </div>
            </div>
            
            <div className="bg-white/5 rounded-xl p-6 border border-pink-500/30">
              <div className="flex items-start gap-4">
                <div className="bg-gradient-to-r from-pink-500 to-orange-500 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white font-black text-xl">2</span>
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg mb-2">‚≠ê Gagner des points</h3>
                  <p className="text-pink-300 text-sm">
                    Gagnez 10 points par euro d√©pens√©. Accumulez 1500 points pour d√©bloquer le statut Premium 
                    et profiter de l'offre exclusive : 2 Puffs au choix pour seulement 15‚Ç¨ !
                  </p>
                </div>
              </div>
            </div>
            
            <div className="bg-white/5 rounded-xl p-6 border border-pink-500/30">
              <div className="flex items-start gap-4">
                <div className="bg-gradient-to-r from-pink-500 to-orange-500 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white font-black text-xl">3</span>
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg mb-2">üéÅ Parrainer des amis</h3>
                  <p className="text-pink-300 text-sm">
                    Partagez votre code de parrainage unique avec vos amis. Vous gagnez 100 points et votre filleul 
                    re√ßoit 50 points de bienvenue !
                  </p>
                </div>
              </div>
            </div>
            
            <div className="bg-white/5 rounded-xl p-6 border border-pink-500/30">
              <div className="flex items-start gap-4">
                <div className="bg-gradient-to-r from-pink-500 to-orange-500 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white font-black text-xl">4</span>
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg mb-2">‚ù§Ô∏è Cr√©er vos favoris</h3>
                  <p className="text-pink-300 text-sm">
                    Cliquez sur le c≈ìur pour ajouter vos produits pr√©f√©r√©s √† vos favoris. Retrouvez-les facilement 
                    dans le menu "Mes Favoris".
                  </p>
                </div>
              </div>
            </div>
            
            <div className="bg-white/5 rounded-xl p-6 border border-pink-500/30">
              <div className="flex items-start gap-4">
                <div className="bg-gradient-to-r from-pink-500 to-orange-500 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
                  <span className="text-white font-black text-xl">5</span>
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg mb-2">üìä Participer au sondage</h3>
                  <p className="text-pink-300 text-sm">
                    Donnez votre avis en s√©lectionnant vos go√ªts pr√©f√©r√©s dans le sondage. Cela nous aide √† am√©liorer 
                    notre catalogue !
                  </p>
                </div>
              </div>
            </div>
          </div>
        </Card>
      );
    };

    // ==================== VUE STATS PRODUCTEUR ====================
    const StatsView = ({ orders, surveyResults }) => {
      const stats = useMemo(() => {
        const totalRevenue = orders.reduce((s, o) => s + o.total, 0);
        const productStats = {};
        
        orders.forEach(o => 
          o.items.forEach(i => {
            if (!productStats[i.id]) productStats[i.id] = { name: i.name, qty: 0, revenue: 0 };
            productStats[i.id].qty += i.qty;
            productStats[i.id].revenue += i.price * i.qty;
          })
        );
        
        const topProduct = Object.values(productStats).sort((a, b) => b.qty - a.qty)[0];
        
        return {
          totalRevenue,
          totalOrders: orders.length,
          productsSold: orders.reduce((s, o) => s + o.items.reduce((a, i) => a + i.qty, 0), 0),
          topProduct,
          productStats: Object.values(productStats).sort((a, b) => b.revenue - a.revenue)
        };
      }, [orders]);

      return (
        <div className="space-y-6">
          <Card className="p-6">
            <h2 className="text-3xl font-black text-white mb-6">üìä Statistiques</h2>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div className="bg-gradient-to-br from-pink-500/20 to-orange-500/20 p-6 rounded-xl border-2 border-pink-500/50">
                <Icon name="DollarSign" size={32} className="text-pink-400 mb-2" />
                <p className="text-pink-300 text-sm">Revenu Total</p>
                <p className="text-white text-2xl font-black">{stats.totalRevenue.toFixed(2)}‚Ç¨</p>
              </div>
              
              <div className="bg-gradient-to-br from-pink-500/20 to-orange-500/20 p-6 rounded-xl border-2 border-pink-500/50">
                <Icon name="Package" size={32} className="text-pink-400 mb-2" />
                <p className="text-pink-300 text-sm">Commandes</p>
                <p className="text-white text-2xl font-black">{stats.totalOrders}</p>
              </div>
              
              <div className="bg-gradient-to-br from-pink-500/20 to-orange-500/20 p-6 rounded-xl border-2 border-pink-500/50">
                <Icon name="ShoppingCart" size={32} className="text-pink-400 mb-2" />
                <p className="text-pink-300 text-sm">Produits Vendus</p>
                <p className="text-white text-2xl font-black">{stats.productsSold}</p>
              </div>
              
              <div className="bg-gradient-to-br from-pink-500/20 to-orange-500/20 p-6 rounded-xl border-2 border-pink-500/50">
                <Icon name="TrendingUp" size={32} className="text-pink-400 mb-2" />
                <p className="text-pink-300 text-sm">Top Produit</p>
                <p className="text-white text-lg font-black truncate">{stats.topProduct?.name || 'N/A'}</p>
                {stats.topProduct && (
                  <p className="text-pink-300 text-xs">{stats.topProduct.qty} ventes</p>
                )}
              </div>
            </div>
            
            {stats.productStats.length > 0 && (
              <div>
                <h3 className="text-white font-bold text-xl mb-4">Top Produits par Revenu</h3>
                <div className="space-y-2">
                  {stats.productStats.slice(0, 5).map((prod, idx) => (
                    <div key={idx} className="bg-white/5 p-4 rounded-xl flex justify-between items-center">
                      <div>
                        <p className="text-white font-bold">{prod.name}</p>
                        <p className="text-pink-300 text-sm">{prod.qty} unit√©s vendues</p>
                      </div>
                      <span className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-orange-400">
                        {prod.revenue.toFixed(2)}‚Ç¨
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </Card>
          
          {surveyResults && Object.keys(surveyResults).length > 0 && (
            <Card className="p-6">
              <h2 className="text-2xl font-black text-white mb-6">üìä R√©sultats du Sondage</h2>
              <div className="space-y-3">
                {Object.entries(surveyResults)
                  .sort((a, b) => b[1] - a[1])
                  .map(([flavor, count], idx) => (
                    <div key={idx} className="bg-white/5 p-4 rounded-xl">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-white font-bold">{flavor}</span>
                        <span className="text-pink-400 font-bold">{count} votes</span>
                      </div>
                      <div className="w-full bg-white/10 rounded-full h-2 overflow-hidden">
                        <div 
                          className="h-full bg-gradient-to-r from-pink-500 to-orange-500"
                          style={{ 
                            width: `${(count / Math.max(...Object.values(surveyResults))) * 100}%` 
                          }}
                        />
                      </div>
                    </div>
                  ))}
              </div>
            </Card>
          )}
        </div>
      );
    };

    // ==================== VUE GESTION DES COMPTES (NOUVEAU) ====================
    const AccountsManagementView = ({ users, onDeleteUser }) => {
      const clientUsers = users.filter(u => u.role === 'client');
      
      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üë• Gestion des Comptes</h2>
          
          <div className="bg-pink-500/10 border border-pink-500/30 rounded-xl p-4 mb-6">
            <p className="text-pink-300 text-sm">
              Total des comptes clients : <span className="text-white font-bold">{clientUsers.length}</span>
            </p>
          </div>
          
          {clientUsers.length === 0 ? (
            <div className="text-center py-12">
              <Icon name="Users" size={64} className="mx-auto text-pink-400/30 mb-4" />
              <p className="text-pink-300 text-lg">Aucun compte client enregistr√©</p>
            </div>
          ) : (
            <div className="space-y-3">
              {clientUsers.map((u, idx) => (
                <div key={idx} className="bg-white/5 p-5 rounded-xl border border-pink-500/20 flex justify-between items-center">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <div className="bg-gradient-to-r from-pink-500 to-orange-500 w-10 h-10 rounded-full flex items-center justify-center">
                        <Icon name="Users" size={20} className="text-white" />
                      </div>
                      <div>
                        <p className="text-white font-bold text-lg">{u.name}</p>
                        <p className="text-pink-300 text-sm">üìû {u.phone || 'Non renseign√©'}</p>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mt-3">
                      <div className="bg-pink-500/10 p-2 rounded-lg">
                        <p className="text-pink-300 text-xs">Points</p>
                        <p className="text-white font-bold">‚≠ê {u.points || 0}</p>
                      </div>
                      <div className="bg-pink-500/10 p-2 rounded-lg">
                        <p className="text-pink-300 text-xs">Code parrainage</p>
                        <p className="text-white font-bold text-xs">{u.referralCode}</p>
                      </div>
                    </div>
                    {u.referredBy && (
                      <p className="text-pink-400 text-xs mt-2">
                        üéÅ Parrain√© par: {u.referredBy}
                      </p>
                    )}
                  </div>
                  
                  <button
                    onClick={() => {
                      if (window.confirm(`Supprimer le compte de ${u.name} ?\n\nCette action est irr√©versible.`)) {
                        onDeleteUser(u.name);
                      }
                    }}
                    className="ml-4 bg-red-500/20 hover:bg-red-500/30 text-red-400 p-3 rounded-xl transition"
                  >
                    <Icon name="Trash2" size={20} />
                  </button>
                </div>
              ))}
            </div>
          )}
        </Card>
      );
    };

// ==================== FIN PARTIE 5/6 CORRIG√âE ====================
// COPIEZ LA PARTIE 6/6 (DERNI√àRE) JUSTE APR√àS CETTE LIGNE
// ==================== PARTIE 6/6 : APP PRINCIPAL & ADMIN + FIN (CORRIG√âE) ====================

    // ==================== VUE ADMIN PRODUITS ====================
    const AdminProductsView = ({ products, onAddProduct, onEditProduct, onDeleteProduct }) => {
      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üì¶ Gestion des Produits</h2>
          
          <Button onClick={onAddProduct} className="mb-6">
            <Icon name="Upload" size={20} />
            AJOUTER UN PRODUIT
          </Button>
          
          <div className="space-y-3">
            {products.map(p => (
              <div key={p.id} className="bg-white/5 p-4 rounded-xl flex justify-between items-center border border-pink-500/20">
                <div className="flex items-center gap-3">
                  <img src={p.img || ''} alt={p.name || 'Produit'} className="w-16 h-16 rounded-lg object-cover" />
                  <div>
                    <p className="text-white font-bold">{p.name || 'Sans nom'}</p>
                    <p className="text-pink-300 text-sm">{p.price ? p.price.toFixed(2) : '0.00'}‚Ç¨ - Stock: {p.stock || 0}</p>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={() => onEditProduct(p)} 
                    className="text-blue-400 hover:text-blue-300 p-2 hover:bg-blue-400/10 rounded-lg transition"
                  >
                    <Icon name="Edit" size={20} />
                  </button>
                  <button 
                    onClick={() => onDeleteProduct(p.id)} 
                    className="text-red-400 hover:text-red-300 p-2 hover:bg-red-400/10 rounded-lg transition"
                  >
                    <Icon name="Trash2" size={20} />
                  </button>
                </div>
              </div>
            ))}
          </div>
        </Card>
      );
    };

    // ==================== VUE ADMIN COMMANDES ====================
    const AdminOrdersView = ({ orders, onConfirmOrder, onDeleteOrder }) => {
      return (
        <Card className="p-6">
          <h2 className="text-3xl font-black text-white mb-6">üìã Gestion des Commandes</h2>
          
          {orders.length === 0 ? (
            <div className="text-center py-12">
              <Icon name="Package" size={64} className="mx-auto text-pink-400/30 mb-4" />
              <p className="text-pink-300 text-lg">Aucune commande</p>
            </div>
          ) : (
            <div className="space-y-4">
              {orders.sort((a, b) => b.id - a.id).map(o => (
                <div key={o.id} className="bg-white/5 p-5 rounded-xl border border-pink-500/30">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <div className="flex items-center gap-3 mb-2">
                        <p className="text-white font-bold text-lg">üë§ {o.user}</p>
                        {getStatusBadge(o.status)}
                      </div>
                      <p className="text-pink-300 text-sm">üìû {o.phone || 'Non renseign√©'}</p>
                      <p className="text-pink-300 text-sm">üìç {o.address}</p>
                      <p className="text-pink-300 text-sm">üí≥ {o.payment}</p>
                      <p className="text-pink-300 text-sm">üïê {o.date}</p>
                      {o.deliveryDate && (
                        <div className="mt-2 bg-green-500/10 border border-green-500/30 p-2 rounded inline-block">
                          <p className="text-green-400 text-xs">üìÖ {o.deliveryDate} √† {o.deliveryTime}</p>
                        </div>
                      )}
                    </div>
                    
                    <div className="text-right">
                      <p className="text-white font-black text-2xl mb-2">{o.total.toFixed(2)}‚Ç¨</p>
                      <div className="flex gap-2 flex-col">
                        {o.status === 'pending' && (
                          <button 
                            onClick={() => onConfirmOrder(o)} 
                            className="bg-green-500/20 hover:bg-green-500/30 text-green-400 text-xs px-3 py-2 rounded-lg transition"
                          >
                            ‚úÖ Confirmer
                          </button>
                        )}
                        <button 
                          onClick={() => onDeleteOrder(o.id)} 
                          className="bg-red-500/20 hover:bg-red-500/30 text-red-400 text-xs px-3 py-2 rounded-lg transition"
                        >
                          üóëÔ∏è Supprimer
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div className="pt-3 border-t border-pink-500/30">
                    <p className="text-pink-300 text-sm mb-2 font-semibold">Articles:</p>
                    {o.items.map(i => (
                      <p key={i.id} className="text-pink-300 text-sm">
                        ‚Ä¢ {i.name} x{i.qty} - {(i.price * i.qty).toFixed(2)}‚Ç¨
                      </p>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </Card>
      );
    };

    // ==================== COMPOSANT APP PRINCIPAL ====================
    function App() {
      // Donn√©es initiales
      const INITIAL_USERS = [{ 
        name: 'Bradley', 
        password: 'Brad@mar270508', 
        role: 'producer', 
        phone: '', 
        referralCode: 'PUFFBRA123456',
        points: 0
      }];
      
      const INITIAL_PRODUCTS = [
        { id: 1, name: 'Coque Galaxy', price: 10.00, stock: 10, img: 'https://images.unsplash.com/photo-1601784551446-20c9e07cdbdb?w=400', desc: 'Design Puff Jr color√©' },
        { id: 2, name: 'Coque Neon', price: 10.00, stock: 8, img: 'https://images.unsplash.com/photo-1556656793-08538906a9f8?w=400', desc: 'Style n√©on vibrant' },
        { id: 3, name: 'Coque Cosmic', price: 10.00, stock: 15, img: 'https://images.unsplash.com/photo-1598327105666-5b89351aff97?w=400', desc: 'Motifs cosmiques' }
      ];

      // √âtats
      const [view, setView] = useState('home');
      const [user, setUser] = useState(null);
      const [search, setSearch] = useState('');
      const [cart, setCart] = useState([]);
      const [users, setUsers] = useState(INITIAL_USERS);
      const [products, setProducts] = useState(INITIAL_PRODUCTS);
      const [orders, setOrders] = useState([]);
      const [checkoutForm, setCheckoutForm] = useState({ address: '', payment: '', promoCode: '' });
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [showSurvey, setShowSurvey] = useState(false);
      const [showScanner, setShowScanner] = useState(false);
      const [showTutorial, setShowTutorial] = useState(false);
      const [favorites, setFavorites] = useState([]);
      const [userFlavors, setUserFlavors] = useState([]);
      const [allFlavors, setAllFlavors] = useState(INITIAL_FLAVORS);
      const [surveyResults, setSurveyResults] = useState({});
      const [loading, setLoading] = useState(true);

      // Chargement initial des donn√©es depuis Firebase
      useEffect(() => {
        const loadData = async () => {
          setLoading(true);
          try {
            console.log('üîÑ Chargement des donn√©es depuis Firebase...');
            
            const loadedUsers = await loadFromFirestore('pshop_users', INITIAL_USERS);
            const loadedProducts = await loadFromFirestore('pshop_products', INITIAL_PRODUCTS);
            const loadedOrders = await loadFromFirestore('pshop_orders', []);
            const loadedFlavors = await loadFromFirestore('pshop_all_flavors', INITIAL_FLAVORS);
            const loadedSurvey = await loadFromFirestore('pshop_survey_results', {});

            // NETTOYAGE DES PRODUITS
            const cleanedProducts = loadedProducts.filter(p => {
              if (!p || typeof p !== 'object') return false;
              if (!p.id || !p.name || p.price === undefined || p.stock === undefined) {
                console.warn('‚ö†Ô∏è Produit invalide d√©tect√© et supprim√©:', p);
                return false;
              }
              return true;
            }).map(p => ({
              ...p,
              price: Number(p.price) || 0,
              stock: Number(p.stock) || 0
            }));

            setUsers(loadedUsers);
            setProducts(cleanedProducts);
            setOrders(loadedOrders);
            setAllFlavors(loadedFlavors);
            setSurveyResults(loadedSurvey);
            
            // V√âRIFIER SI ON DOIT RESTER CONNECT√â (LocalStorage)
            const savedUsername = localStorage.getItem('pshop_remember_user');
            if (savedUsername) {
              const savedUser = loadedUsers.find(u => u.name === savedUsername);
              if (savedUser) {
                setUser(savedUser);
                
                const userFavs = await loadFromFirestore('pshop_favorites_' + savedUser.name, []);
                const userFlav = await loadFromFirestore('pshop_user_flavors_' + savedUser.name, []);
                setFavorites(userFavs);
                setUserFlavors(userFlav);
                
                console.log('‚úÖ Connexion automatique:', savedUser.name);
              }
            }
            
            console.log('‚úÖ Toutes les donn√©es charg√©es');
          } catch (error) {
            console.error('‚ùå Erreur chargement:', error);
          } finally {
            setLoading(false);
          }
        };
        loadData();
      }, []);

      // Sauvegarde automatique dans Firebase
      useEffect(() => { 
        if (!loading && users.length > 0) {
          saveToFirestore('pshop_users', users);
        }
      }, [users, loading]);
      
      useEffect(() => { 
        if (!loading && products.length > 0) {
          saveToFirestore('pshop_products', products);
        }
      }, [products, loading]);
      
      useEffect(() => { 
        if (!loading) {
          saveToFirestore('pshop_orders', orders);
        }
      }, [orders, loading]);
      
      useEffect(() => { 
        if (user && !loading) {
          saveToFirestore('pshop_favorites_' + user.name, favorites);
        }
      }, [favorites, user, loading]);
      
      useEffect(() => { 
        if (user && !loading) {
          saveToFirestore('pshop_user_flavors_' + user.name, userFlavors);
        }
      }, [userFlavors, user, loading]);
      
      useEffect(() => { 
        if (!loading) {
          saveToFirestore('pshop_all_flavors', allFlavors);
        }
      }, [allFlavors, loading]);
      
      useEffect(() => { 
        if (!loading) {
          saveToFirestore('pshop_survey_results', surveyResults);
        }
      }, [surveyResults, loading]);

      // Calculs m√©moris√©s
      const cartTotal = useMemo(() => cart.reduce((s, i) => s + i.price * i.qty, 0), [cart]);
      const cartItemCount = useMemo(() => cart.reduce((s, i) => s + i.qty, 0), [cart]);
      const myOrders = useMemo(() => orders.filter(o => o.user === user?.name), [orders, user]);
      const myReferrals = useMemo(() => users.filter(u => u.referredBy === user?.referralCode), [users, user]);

      // Handlers
      const handleLogin = useCallback(async (form, rememberMe) => {
        const u = users.find(u => u.name === form.name && u.password === form.password);
        if (u) {
          setUser(u);
          
          // UTILISER LOCALSTORAGE POUR RESTER CONNECT√â (PAR APPAREIL)
          if (rememberMe) {
            localStorage.setItem('pshop_remember_user', u.name);
            console.log('‚úÖ Rester connect√© activ√© pour:', u.name);
          } else {
            localStorage.removeItem('pshop_remember_user');
          }
          
          const userFavs = await loadFromFirestore('pshop_favorites_' + u.name, []);
          const userFlav = await loadFromFirestore('pshop_user_flavors_' + u.name, []);
          setFavorites(userFavs);
          setUserFlavors(userFlav);
          
          console.log('‚úÖ Connexion r√©ussie:', u.name);
        } else {
          alert('Identifiant ou mot de passe incorrect');
        }
      }, [users]);

      const handleRegister = useCallback(async (form, rememberMe) => {
        if (users.find(u => u.name === form.name)) return alert('Ce nom d\'utilisateur existe d√©j√†');
        
        const newUser = {
          name: form.name,
          password: form.password,
          phone: form.phone,
          role: 'client',
          referralCode: generateReferralCode(form.name),
          referredBy: form.referralCode || null,
          points: 0
        };

        // Bonus parrainage
        let updatedUsers = [...users];
        if (form.referralCode) {
          const referrerIndex = users.findIndex(u => u.referralCode === form.referralCode);
          if (referrerIndex !== -1) {
            newUser.points = 50;
            updatedUsers[referrerIndex] = {
              ...updatedUsers[referrerIndex],
              points: (updatedUsers[referrerIndex].points || 0) + 100
            };
          }
        }

        updatedUsers.push(newUser);
        setUsers(updatedUsers);
        
        await saveToFirestore('pshop_users', updatedUsers);
        
        // UTILISER LOCALSTORAGE POUR RESTER CONNECT√â
        if (rememberMe) {
          localStorage.setItem('pshop_remember_user', newUser.name);
        }
        
        setUser(newUser);
        
        // AFFICHER LE TUTORIEL AU PREMIER LANCEMENT
        setShowTutorial(true);
        
        alert(`Bienvenue ${form.name} ! üéâ${newUser.points > 0 ? ` Vous avez re√ßu ${newUser.points} points de bienvenue !` : ''}`);
        
        console.log('‚úÖ Nouveau compte cr√©√©:', newUser.name);
      }, [users]);

      const handleLogout = useCallback(async () => {
        // SUPPRIMER UNIQUEMENT DE LOCALSTORAGE (PAR APPAREIL)
        localStorage.removeItem('pshop_remember_user');
        
        setUser(null);
        setCart([]);
        setView('home');
        setFavorites([]);
        
        console.log('‚úÖ D√©connexion r√©ussie');
      }, []);

      const addToCart = useCallback((p) => {
        if (p.stock <= 0) return alert('Produit en rupture de stock');
        setCart(prev => {
          const ex = prev.find(i => i.id === p.id);
          if (ex) {
            if (ex.qty >= p.stock) {
              alert('Stock insuffisant');
              return prev;
            }
            return prev.map(i => i.id === p.id ? {...i, qty: i.qty + 1} : i);
          }
          return [...prev, {...p, qty: 1}];
        });
      }, []);

      const updateCartQty = useCallback((id, delta) => {
        setCart(prev => prev.map(i => {
          if (i.id === id) {
            const newQty = i.qty + delta;
            const product = products.find(p => p.id === id);
            if (newQty > product.stock) {
              alert('Stock insuffisant');
              return i;
            }
            return {...i, qty: Math.max(1, newQty)};
          }
          return i;
        }));
      }, [products]);

      const handleCheckout = useCallback(() => {
        if (!checkoutForm.address || !checkoutForm.payment) {
          return alert('Veuillez remplir tous les champs');
        }

        const pointsEarned = Math.floor(cartTotal * 10);
        const userInfo = users.find(u => u.name === user.name);

        const newOrder = {
          id: Date.now(),
          user: user.name,
          phone: userInfo?.phone || '',
          items: [...cart],
          total: cartTotal,
          address: checkoutForm.address,
          payment: checkoutForm.payment,
          date: new Date().toLocaleString('fr-FR'),
          status: 'pending',
          deliveryDate: null,
          deliveryTime: null,
          pointsEarned
        };

        setProducts(prev => prev.map(p => {
          const cartItem = cart.find(c => c.id === p.id);
          return cartItem ? {...p, stock: p.stock - cartItem.qty} : p;
        }));

        setUsers(prev => prev.map(u => 
          u.name === user.name 
            ? {...u, points: (u.points || 0) + pointsEarned}
            : u
        ));

        setUser(prev => ({...prev, points: (prev.points || 0) + pointsEarned}));

        setOrders(prev => [...prev, newOrder]);
        setCart([]);
        setCheckoutForm({ address: '', payment: '', promoCode: '' });
        alert(`Commande confirm√©e ! üéâ\nVous avez gagn√© ${pointsEarned} points !`);
        setView('orders');
      }, [checkoutForm, cart, cartTotal, user, users]);

      const confirmOrder = useCallback((order) => {
        const deliveryDate = prompt('Date de livraison (ex: 15/12/2024):');
        if (!deliveryDate) return;

        const deliveryTime = prompt('Heure de livraison (ex: 14h30):');
        if (!deliveryTime) return;

        setOrders(prev => prev.map(o =>
          o.id === order.id
            ? {...o, status: 'confirmed', deliveryDate, deliveryTime}
            : o
        ));

        alert('Commande confirm√©e avec succ√®s !');
      }, []);

      const handleScannerValidate = useCallback((orderCode) => {
        const orderIdMatch = orderCode.match(/\d+/);
        if (!orderIdMatch) {
          alert('Code invalide');
          return;
        }

        const orderId = parseInt(orderIdMatch[0]);
        const order = orders.find(o => o.id === orderId);

        if (!order) {
          alert('Commande introuvable');
          return;
        }

        setOrders(prev => prev.map(o =>
          o.id === orderId ? {...o, status: 'delivered'} : o
        ));

        alert('‚úÖ Commande marqu√©e comme livr√©e !');
      }, [orders]);

      const toggleFavorite = useCallback((productId) => {
        setFavorites(prev =>
          prev.includes(productId)
            ? prev.filter(id => id !== productId)
            : [...prev, productId]
        );
      }, []);

      const handleSurveySubmit = useCallback((selectedFlavors) => {
        setUserFlavors(selectedFlavors);

        const newFlavors = selectedFlavors.filter(f => !allFlavors.includes(f));
        if (newFlavors.length > 0) {
          setAllFlavors(prev => [...prev, ...newFlavors]);
        }

        setSurveyResults(prev => {
          const updated = {...prev};
          selectedFlavors.forEach(flavor => {
            updated[flavor] = (updated[flavor] || 0) + 1;
          });
          return updated;
        });

        alert('Merci pour votre participation ! üéâ');
      }, [allFlavors]);

      const addProduct = useCallback(() => {
        const name = prompt('Nom du produit');
        if (!name || !name.trim()) return alert('Nom invalide');

        const priceStr = prompt('Prix (‚Ç¨)', '10.00');
        const price = parseFloat(priceStr);
        if (isNaN(price) || price < 0) return alert('Prix invalide');

        const stockStr = prompt('Quantit√© en stock', '10');
        const stock = parseInt(stockStr);
        if (isNaN(stock) || stock < 0) return alert('Quantit√© invalide');

        const desc = prompt('Description du produit');
        if (!desc || !desc.trim()) return alert('Description invalide');

        const imgUrl = prompt('URL de l\'image\n\nVous pouvez uploader sur:\n- https://postimg.cc/\n- https://imgur.com/\n\nPuis coller le lien direct', 'https://images.unsplash.com/photo-1598327105666-5b89351aff97?w=400');
        if (!imgUrl || !imgUrl.trim()) return alert('URL image invalide');

        const newProduct = {
          id: Date.now(),
          name: name.trim(),
          price: Number(price),
          stock: Number(stock),
          img: imgUrl.trim(),
          desc: desc.trim()
        };
        
        console.log('‚úÖ Nouveau produit cr√©√©:', newProduct);
        setProducts(prev => [...prev, newProduct]);
        alert('‚úÖ Produit ajout√© avec succ√®s !');
      }, []);

      const editProduct = useCallback((p) => {
        const name = prompt('Nouveau nom', p.name);
        if (!name) return;

        const price = parseFloat(prompt('Nouveau prix', p.price));
        if (!price || isNaN(price)) return alert('Prix invalide');

        const stock = parseInt(prompt('Nouveau stock', p.stock));
        if (isNaN(stock) || stock < 0) return alert('Stock invalide');

        const desc = prompt('Description', p.desc);
        if (!desc) return;

        setProducts(prev => prev.map(pr =>
          pr.id === p.id ? {...pr, name, price, stock, desc} : pr
        ));
        alert('Produit modifi√© !');
      }, []);

      const deleteProduct = useCallback((id) => {
        if (window.confirm('Supprimer ce produit ?')) {
          setProducts(prev => prev.filter(p => p.id !== id));
          alert('Produit supprim√© !');
        }
      }, []);

      const deleteOrder = useCallback((id) => {
        if (window.confirm('Supprimer cette commande ?')) {
          setOrders(prev => prev.filter(o => o.id !== id));
          alert('Commande supprim√©e !');
        }
      }, []);

      const deleteUser = useCallback((username) => {
        setUsers(prev => prev.filter(u => u.name !== username));
        alert(`Compte de ${username} supprim√© !`);
      }, []);

      // Rendu
      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 via-pink-800 to-orange-700 flex items-center justify-center">
            <Card className="p-12 text-center">
              <div className="w-32 h-32 mx-auto mb-4">
                <img 
                  src="https://i.postimg.cc/ZRscyVKS/b4beb632-78c8-4f8d-8491-02da1b2545ee.png" 
                  alt="P-Shop Logo" 
                  className="w-full h-full object-contain drop-shadow-2xl animate-pulse"
                />
              </div>
              <p className="text-pink-300 text-lg">Chargement depuis Firebase...</p>
            </Card>
          </div>
        );
      }

      if (!user) return <LoginView onLogin={handleLogin} onRegister={handleRegister} />;

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 via-pink-800 to-orange-700">
          <Navigation
            user={user}
            cartCount={cartItemCount}
            onNavigate={setView}
            onLogout={handleLogout}
            points={user.points || 0}
          />

          <div className="max-w-7xl mx-auto p-6">
            {user.role === 'client' && view === 'home' && (
              <LoyaltyDisplay points={user.points || 0} />
            )}

            {view === 'home' && (
              <HomeView
                products={products}
                search={search}
                setSearch={setSearch}
                onAddToCart={addToCart}
                onProductClick={setSelectedProduct}
                favorites={favorites}
                onToggleFavorite={toggleFavorite}
                onOpenSurvey={() => setShowSurvey(true)}
                userRole={user.role}
                userFlavors={userFlavors}
                userPoints={user.points || 0}
              />
            )}

            {view === 'favorites' && user.role === 'client' && (
              <FavoritesView
                products={products}
                favorites={favorites}
                onProductClick={setSelectedProduct}
                onAddToCart={addToCart}
                onToggleFavorite={toggleFavorite}
              />
            )}

            {view === 'cart' && user.role === 'client' && (
              <CartView
                cart={cart}
                onUpdateQty={updateCartQty}
                onRemoveItem={(id) => setCart(prev => prev.filter(x => x.id !== id))}
                onCheckout={handleCheckout}
                checkoutForm={checkoutForm}
                setCheckoutForm={setCheckoutForm}
              />
            )}

            {view === 'orders' && user.role === 'client' && (
              <OrdersView orders={myOrders} />
            )}

            {view === 'referral' && user.role === 'client' && (
              <ReferralView user={user} referrals={myReferrals} />
            )}

            {view === 'promo' && user.role === 'client' && (
              <PromoView promoCodes={[]} />
            )}

            {view === 'tutorial' && user.role === 'client' && (
              <TutorialView />
            )}

            {view === 'stats' && user.role === 'producer' && (
              <StatsView orders={orders} surveyResults={surveyResults} />
            )}

            {view === 'admin' && user.role === 'producer' && (
              <div className="space-y-6">
                <AdminProductsView
                  products={products}
                  onAddProduct={addProduct}
                  onEditProduct={editProduct}
                  onDeleteProduct={deleteProduct}
                />
                <AdminOrdersView
                  orders={orders}
                  onConfirmOrder={confirmOrder}
                  onDeleteOrder={deleteOrder}
                />
              </div>
            )}

            {view === 'accounts' && user.role === 'producer' && (
              <AccountsManagementView
                users={users}
                onDeleteUser={deleteUser}
              />
            )}

            {view === 'scanner' && user.role === 'producer' && (
              <Card className="p-12 text-center">
                <Icon name="Camera" size={64} className="mx-auto text-pink-400 mb-4" />
                <h2 className="text-2xl font-black text-white mb-4">Scanner QR Code</h2>
                <Button onClick={() => setShowScanner(true)}>
                  <Icon name="Camera" size={20} />
                  OUVRIR LE SCANNER
                </Button>
              </Card>
            )}
          </div>

          {selectedProduct && (
            <Modal
              product={selectedProduct}
              onClose={() => setSelectedProduct(null)}
              onAddToCart={user.role === 'client' ? addToCart : null}
              isFavorite={favorites.includes(selectedProduct.id)}
              onToggleFavorite={user.role === 'client' ? toggleFavorite : null}
            />
          )}

          {showSurvey && (
            <SurveyModal
              onClose={() => setShowSurvey(false)}
              flavors={allFlavors}
              onSubmit={handleSurveySubmit}
              userFlavors={userFlavors}
            />
          )}

          {showScanner && (
            <QRScannerModal
              onClose={() => setShowScanner(false)}
              onValidate={handleScannerValidate}
            />
          )}

          {showTutorial && (
            <TutorialModal
              onClose={() => setShowTutorial(false)}
            />
          )}
        </div>
      );
    }

    // ==================== RENDU FINAL ====================
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
  <!-- Service Worker - METTRE ICI -->
    <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js');
    }
    </script>
</body>
</html>

